import { type Tiktoken } from 'tiktoken'
import Graphemer from 'graphemer'

const textDecoder = new TextDecoder()
const graphemer = new Graphemer()

export function getSegments(encoder: Tiktoken, inputText: string) {
  const encoding = encoder.encode(inputText, 'all')
  const segments: { text: string; tokens: { id: number; idx: number }[] }[]
    = []

  let byteAcc: number[] = []
  let tokenAcc: { id: number; idx: number }[] = []
  let inputGraphemes = graphemer.splitGraphemes(inputText)
  let tokensCount = 0

  for (let idx = 0; idx < encoding.length; idx++) {
    const token = encoding[idx]!
    byteAcc.push(...encoder.decode_single_token_bytes(token))
    tokenAcc.push({ id: token, idx })

    const segmentText = textDecoder.decode(new Uint8Array(byteAcc))
    const graphemes = graphemer.splitGraphemes(segmentText)

    if (graphemes.every((item, idx) => inputGraphemes[idx] === item)) {
      segments.push({ text: segmentText, tokens: tokenAcc })

      tokensCount += tokenAcc.length
      byteAcc = []
      tokenAcc = []
      inputGraphemes = inputGraphemes.slice(graphemes.length)
    }
  }

  return { segments, tokensCount }
}
